// FGCM test: fsaverage override + audiotest + CSplusUnpaired
// This file is intended to be mounted as /program/nextflow/nextflow.config

nextflow.enable.dsl=2

includeConfig "/program/nextflow/nextflow_for_docker.config"

params {
    // Use fsaverage template for all subjects with per-subject scaling
    do_fs = false
    mri_template_policy = "override"

    // Write outputs under derivatives/megprep in the output directory
    preproc_dir = "${params.output_dir}/derivatives/megprep/preprocessed"
    derivatives_dir = "${params.output_dir}/derivatives/megprep"
    template_fs_subjects_dir = "${params.derivatives_dir}/freesurfer/subjects"

    // Limit scope for a small test
    meg_import_config = """
    subject_id:
      - "001"
    task:
      - "audiotest"
    """

    // CTF-friendly preprocessing
    preproc_config = """
    preproc:
      - filter: {l_freq: 0.5, h_freq: 45, method: iir, iir_params: {order: 5, ftype: butter}}
      - notch_filter: {freqs: 50 100 150}
      - resample: {sfreq: 200}
    """

    // Eyetracker pupil preprocessing defaults
    pupil_preproc_enabled = true
    pupil_preproc_config = """
        channel_prefix: "UADC007"
        gaze_x_prefix: "UADC005"
        gaze_y_prefix: "UADC006"
        z_thresh: 6.0
        velocity_k: 8.0
        smoothing_window_s: 0.01
        min_dur_s: 0.03
        merge_gap_s: 0.05
        pad_s: 0.10
        max_blink_dur_s: 1.0
        max_interp_gap_s: 0.5
        gaze_velocity_enabled: true
        gaze_velocity_smoothing_s: 0.01
        virtual_eog_enabled: true
        virtual_eog_lowpass_hz: 10.0
    """

    // Artifact detection defaults + vendor hint
    artifact_config = """
    find_bad_channels:
        pyprep:
            deviation:
                deviation_threshold: 5.0
            snr: {}
            nan_flat: {}
        psd:
            std_multiplier: 6
        osl:
            ref_meg: auto
            significance_level: 0.05
        mne:
            find_bad_channels_lof:
                n_neighbors: 20
                picks: mag
                metric: euclidean
                threshold: 1.5

    find_bad_segments:
        osl:
            segment_len: 1000
        mne:
            annotate_muscle_zscore:
                ch_type: mag
                threshold: 12

    artifact_images_enabled: true
    meg_vendor: 'ctf'
    """

    // ICA labeling (MEGNet + rules + MNE ECG/EOG)
    ic_label_config = """
    mne_algorithm: true
    rules_algorithm: true
    ica_label: true

    ic_ecg: true
    ic_eog: true
    ic_outlier: true

    find_bads_ecg:
      ch_name: ECG
      threshold: auto
      method: ctps
      l_freq: 8
      h_freq: 16
      measure: zscore

    find_bads_eog:
      ch_name: null
      threshold: auto
      l_freq: 1
      h_freq: 10
      measure: zscore

    ICA_classify:
      meg_vendor: ctf
      explained_var:
        threshold: 0.1
        ch_type: mag
    """

    // Epoch from BIDS events.tsv, keep only CSplusUnpaired
    epoch_config = """
    task_type: 'task'
    event_source: 'event_file'

    event_file:
      trial_type:
        - CSplusUnpaired

    autoreject: false

    epochs:
      tmin: -0.2
      tmax: 0.8
      baseline: [-0.2, 0.0]
      picks: meg
      reject_by_annotation: true
      preload: true
    """
}

// Nextflow work directory (use local tmp, avoid symlinks on external drive)
workDir = "/tmp/work"
